<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>EdLab Studio - Seen In NY</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body {
        	margin:0;
        	padding:0;
        }
        #map {
        	position:absolute;
        	top:0;
        	bottom:0;
        	width:100%;
        }
    </style>
</head>
<body>

<div id='map'></div>

<script>
accessToken = 'pk.eyJ1Ijoic2hvaGE5OSIsImEiOiJaMTFkbWtZIn0.2ohvXTb0qeQUH2I-flBkmg';
var mapLoaded = false;
var dataLoaded = false;
var geojson_data = null;
var latest_data = null;

mapboxgl.accessToken = accessToken.toString();
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/shoha99/ciyzv99pc004n2sq8c2eh9lot',
    scrollZoom: false,
    center: [-73.965, 40.785],
    zoom: 10
});

// Add zoom and rotation controls to the map.
map.addControl(new mapboxgl.NavigationControl());

map.on('load', function () {
    console.log("map loaded");
    mapLoaded = true;
    if (dataLoaded === true) {
        render_geojson();
    };
})

var dataset_api = "https://api.mapbox.com/datasets/v1/shoha99/ciyloqvms00302wk1sl0tpt1c/features";
$.get(dataset_api, {access_token: accessToken}, function (data) {
    geojson_data = {type: "FeatureCollection", features: []};
    latest_data = {type: "FeatureCollection", features: []};

    var features = data.features;
    features.sort(function (a, b) {
        var dateOfA = a.properties.date,
            dateOfB = b.properties.date;
        if(!dateOfA && !dateOfB) {
            return 0;
        }
        if(!dateOfA || !dateOfB) {
            return 1;
        }
        return new Date(dateOfA).getTime() - new Date(dateOfB).getTime();
    })

    var latest = features.pop();
    latest_data.features.push(latest);
    geojson_data.features = features;

    console.log("data loaded");
    dataLoaded = true;
    if (mapLoaded === true) {
        render_geojson();
    };
})

var render_geojson = function () {
    console.log("rendering data");
    map.addSource('siny_points', {
        type: 'geojson',
        data: geojson_data
    });
    map.addLayer({
        'id': 'siny_points',
        'type': 'symbol',
        'source': 'siny_points',
        'layout': {
            'icon-image': 'marker-15-green'
        }
    });

    map.addSource('siny_latest_point', {
        type: 'geojson',
        data: latest_data
    });
    map.addLayer({
        'id': 'siny_latest_point',
        'type': 'symbol',
        'source': 'siny_latest_point',
        'layout': {
            'icon-image': 'marker-15-yellow'
        }
    });

    map.on('click', function (e) {
        var features = map.queryRenderedFeatures(e.point, {layers: ['siny_points', 'siny_latest_point']});
        if (!features.length) {
            return;
        }
        var feature = features[0];

        var description = feature.properties.description === undefined ?
            "<a target='_blank' href='" + feature.properties.vialogue + "'><img width=275 src='" + feature.properties.image + "'></a>" : feature.properties.description;

        var popup = new mapboxgl.Popup({offset: [0,-15]})
            .setLngLat(feature.geometry.coordinates)
            .setHTML('<h3>' + feature.properties.title + '</h3><p>' + description + '</p>')
            .setLngLat(feature.geometry.coordinates)
            .addTo(map);
    });

    map.on('mousemove', function (e) {
        var features = map.queryRenderedFeatures(e.point, { layers: ['siny_points', 'siny_latest_point']});
        map.getCanvas().style.cursor = features.length ? 'pointer' : '';
    });
};
</script>
