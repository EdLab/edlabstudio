<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>EdLab Studio - Seen In NY</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.css' rel='stylesheet' />
    <link href='/header.css' rel='stylesheet' />
    <link href='/marker_list.css' rel='stylesheet' />
    <style>
        body {
          	margin:0;
          	padding:0;
        }
        #map {
          	position:absolute;
          	top:0;
          	bottom:0;
          	width:100%;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-fixed-bottom">
    <div class="container">
        <div class="row">
            <div class="col-xs-6 col-sm-6 col-md-6 margin--top-10">
                <div class="navbar-header all-caps">
                    <a href="/" class="navbar-brand text--white">
                        <img src="/img/logos/Edlab_header_black.png">
                    </a>
                </div>
            </div>
        </div>
    </div>
</nav>

<div class="marker-list-box">
    <div class="marker-list-header-box">

    </div>
    <div class="marker-list-description-box">

    </div>
    <div class="marker-list-list-box">

    </div>
</div>

<div id='map'></div>

<script>

function slugify(text) {
    return text.toString().toLowerCase()
        .replace(/\s+/g, '-')           // Replace spaces with -
        .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
        .replace(/\-\-+/g, '-')         // Replace multiple - with single -
        .replace(/^-+/, '')             // Trim - from start of text
        .replace(/-+$/, '');            // Trim - from end of text
}

accessToken = 'pk.eyJ1Ijoic2hvaGE5OSIsImEiOiJaMTFkbWtZIn0.2ohvXTb0qeQUH2I-flBkmg';
var mapLoaded = false;
var dataLoaded = false;
var geojson_data = null;
var latest_data = null;
var detectClose = null;

mapboxgl.accessToken = accessToken.toString();
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/shoha99/ciylp3yo8004g2smg0wryxo48',
    scrollZoom: false,
    center: [-73.965, 40.785],
    zoom: 10
});

// Add zoom and rotation controls to the map.
map.addControl(new mapboxgl.NavigationControl());

map.on('load', function () {
    console.log("map loaded");
    mapLoaded = true;
    if (dataLoaded === true) {
        render_map();
    };
})

var dataset_api = "https://api.mapbox.com/datasets/v1/shoha99/ciyloqvms00302wk1sl0tpt1c/features";
$.get(dataset_api, {access_token: accessToken}, function (data) {
    geojson_data = {type: "FeatureCollection", features: []};
    latest_data = {type: "FeatureCollection", features: []};

    var features = data.features;
    features.sort(function (a, b) {
        var dateOfA = a.properties.date,
            dateOfB = b.properties.date;
        if(!dateOfA && !dateOfB) {
            return 0;
        }
        if(!dateOfA || !dateOfB) {
            return 1;
        }
        return new Date(dateOfA).getTime() - new Date(dateOfB).getTime();
    })

    var latest = features.pop();
    latest_data.features.push(latest);
    geojson_data.features = features;

    console.log("data loaded");
    dataLoaded = true;
    if (mapLoaded === true) {
        render_map();
    };
})

var render_map = function () {
    console.log("rendering data");
    map.addSource('siny_points', {
        type: 'geojson',
        data: geojson_data
    });
    map.addLayer({
        'id': 'siny_points',
        'type': 'symbol',
        'source': 'siny_points',
        'layout': {
            'icon-image': 'marker-15-green',
            'icon-allow-overlap': true,
        }
    });

    map.addSource('siny_latest_point', {
        type: 'geojson',
        data: latest_data
    });
    map.addLayer({
        'id': 'siny_latest_point',
        'type': 'symbol',
        'source': 'siny_latest_point',
        'layout': {
            'icon-image': 'marker-15-yellow',
            'icon-allow-overlap': true,
        }
    });

    map.on('click', function (e) {
        var features = map.queryRenderedFeatures(e.point, {layers: ['siny_points', 'siny_latest_point']});
        if (!features.length) {
            return;
        }
        var feature = features[0];
        render_popup(feature);
    });

    map.on('mousemove', function (e) {
        var features = map.queryRenderedFeatures(e.point, { layers: ['siny_points', 'siny_latest_point']});
        map.getCanvas().style.cursor = features.length ? 'pointer' : '';
    });

    var current_url = window.location.href;
    var split = current_url.split('/#');
    if (split.length > 1) {
        var feature_slug = split[1];
        if (slugify(latest_data.features[0].properties.title) === feature_slug) {
            render_popup(latest_data.features[0])
        } else {
            for (var i = 0; i < geojson_data.features.length; i++) {
                if (slugify(geojson_data.features[i].properties.title) === feature_slug) {
                    render_popup(geojson_data.features[i])
                    break;
                }
            }
        }
    }
};

var render_popup = function (feature) {
    var description = feature.properties.description === undefined ?
        "<a target='_blank' href='" + feature.properties.vialogue + "'><img width=275 src='" + feature.properties.image + "'></a>" : feature.properties.description;

    var popup = new mapboxgl.Popup({offset: [0,-15]})
        .setLngLat(feature.geometry.coordinates)
        .setHTML('<h3>' + feature.properties.title + '</h3><p>' + description + '</p>')
        .setLngLat(feature.geometry.coordinates)
        .addTo(map);

    setTimeout(function () {
        history.pushState(null, null, '#' + slugify(feature.properties.title));
    }, 0);
    popup.on('close', function (e) {
        history.pushState(null, null, '/');
    })
}
</script>
